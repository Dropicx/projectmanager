# 🚀 Deployment Guide

## Overview

This guide covers deploying Consailt to production using **Railway** with **Next.js 15**, **Drizzle ORM**, and **tRPC**. The deployment includes both web and worker services with PostgreSQL and Redis databases, optimized for knowledge management and AI-powered insights.

## 🏗️ Architecture Overview

```
Railway Project
├── Web Service (Next.js 15)
│   ├── Port: 3000
│   ├── Health: /api/health
│   ├── Domain: https://your-app.railway.app
│   └── Features: Knowledge base, AI insights, search
├── Worker Service (Background Jobs)
│   ├── No port (background processing)
│   ├── Processes: BullMQ jobs, Cron jobs
│   ├── Jobs: AI processing, RSS sync, insights generation
│   └── Health: /health endpoint
├── PostgreSQL Database
│   ├── Connection: DATABASE_URL
│   ├── Schema: Knowledge base, users, engagements
│   └── Features: Full-text search, vector embeddings
└── Redis Database
    ├── Connection: REDIS_URL
    ├── Usage: Job queues, caching, sessions
    └── Features: BullMQ, rate limiting
```

## 📋 Prerequisites

- [Railway CLI](https://docs.railway.app/develop/cli) installed
- [Node.js 22+](https://nodejs.org/) installed locally
- [pnpm](https://pnpm.io/) package manager
- AWS account for Bedrock AI services
- Clerk account for authentication

## 🚀 Step-by-Step Deployment

### 1. Railway Project Setup

#### Create New Project
```bash
# Login to Railway
railway login

# Create new project
railway new

# Link to existing project (if you have one)
railway link
```

#### Verify Project Structure
```bash
# Check current project
railway status

# View project details
railway info
```

### 2. Database Services

#### Add PostgreSQL Database
```bash
# Add PostgreSQL service
railway add postgresql

# Verify connection
railway variables | grep DATABASE_URL
```

#### Add Redis Database
```bash
# Add Redis service
railway add redis

# Verify connection
railway variables | grep REDIS_URL
```

### 3. Web Service Configuration

#### Create Web Service
```bash
# Create web service from GitHub repo
railway add --service web

# Configure build settings
railway variables set NODE_ENV=production
railway variables set NEXT_TELEMETRY_DISABLED=1
```

#### Configure Build Commands
```toml
# railway.toml
[build]
builder = "nixpacks"
buildCommand = "pnpm install --frozen-lockfile && pnpm build:web"

[deploy]
startCommand = "pnpm start --filter=@consulting-platform/web"
healthcheckPath = "/api/health"
healthcheckTimeout = 30
port = 3000
```

### 4. Worker Service Configuration

#### Create Worker Service
```bash
# Create worker service
railway add --service worker

# Configure worker settings
railway variables set WORKER_ENABLED=true
```

#### Worker Configuration
```toml
# railway.toml
[services.worker]
startCommand = "pnpm worker:start"
restartPolicyType = "on-failure"
restartPolicyMaxRetries = 3
```

### 5. Environment Variables

#### Required Variables
```bash
# Database (auto-generated by Railway)
DATABASE_URL=postgresql://user:pass@host:5432/db
REDIS_URL=redis://default:pass@host:6379

# Authentication (get from Clerk dashboard)
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_live_xxx
CLERK_SECRET_KEY=sk_live_xxx

# AWS Bedrock (for AI features)
AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=xxx
AWS_SECRET_ACCESS_KEY=xxx

# Application Settings
NODE_ENV=production
NEXT_TELEMETRY_DISABLED=1
ENABLE_AI_INSIGHTS=true
AI_COST_LIMIT_CENTS=50000

# Worker Service Settings
WORKER_ENABLED=true
RSS_FEED_URL=https://rss.the-morpheus.news/rss/high_rating

# Knowledge Base Settings
KNOWLEDGE_BASE_ENABLED=true
SEARCH_ENABLED=true
AI_INSIGHTS_ENABLED=true
```

#### Set Environment Variables
```bash
# Set all variables at once
railway variables set \
  NODE_ENV=production \
  NEXT_TELEMETRY_DISABLED=1 \
  ENABLE_AI_INSIGHTS=true \
  ENABLE_REALTIME_COLLAB=true \
  AI_COST_LIMIT_CENTS=50000

# Set individual variables
railway variables set AWS_REGION=eu-central-1
railway variables set AWS_ACCESS_KEY_ID=your-key
railway variables set AWS_SECRET_ACCESS_KEY=your-secret
```

### 6. Next.js 15 Configuration

#### Optimize for Production
```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  // Enable standalone output for Railway
  output: 'standalone',
  
  // Optimize for production
  compress: true,
  poweredByHeader: false,
  
  // Security headers
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          {
            key: 'Referrer-Policy',
            value: 'origin-when-cross-origin',
          },
        ],
      },
    ]
  },
  
  // Experimental features for Next.js 15
  experimental: {
    serverComponentsExternalPackages: ['@aws-sdk/client-bedrock-runtime'],
    optimizePackageImports: ['@trpc/react-query', 'drizzle-orm'],
  },
  
  // Image optimization
  images: {
    domains: ['images.unsplash.com', 'via.placeholder.com'],
    formats: ['image/webp', 'image/avif'],
  },
}

module.exports = nextConfig
```

#### Package.json Scripts
```json
{
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "build:web": "next build",
    "start": "next start",
    "worker:start": "node apps/worker/dist/index.js",
    "type-check": "tsc --noEmit",
    "lint": "next lint"
  }
}
```

### 7. Drizzle ORM Configuration

#### Database Configuration
```typescript
// packages/database/drizzle.config.ts
import { defineConfig } from 'drizzle-kit'
import { config } from 'dotenv'

config({ path: '.env.local' })

export default defineConfig({
  dialect: 'postgresql',
  schema: './schema.ts',
  out: './migrations',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
  verbose: true,
  strict: true,
})
```

#### Migration Setup
```bash
# Generate migrations
pnpm db:generate

# Push schema to database
pnpm db:push

# Run migrations
pnpm db:migrate
```

### 8. tRPC Configuration

#### Server Configuration
```typescript
// packages/api/trpc/trpc.ts
import { initTRPC } from '@trpc/server'
import { CreateNextContextOptions } from '@trpc/server/adapters/next'
import { auth } from '@clerk/nextjs'
import superjson from 'superjson'
import { ZodError } from 'zod'

export const createTRPCContext = async (opts: CreateNextContextOptions) => {
  const { userId } = auth()
  
  return {
    userId,
    req: opts.req,
    res: opts.res,
  }
}

export const t = initTRPC.context<typeof createTRPCContext>().create({
  transformer: superjson,
  errorFormatter({ shape, error }) {
    return {
      ...shape,
      data: {
        ...shape.data,
        zodError: error.cause instanceof ZodError ? error.cause.flatten() : null,
      },
    }
  },
})
```

#### Client Configuration
```typescript
// apps/web/lib/trpc.ts
import { createTRPCReact } from '@trpc/react-query'
import { httpBatchLink } from '@trpc/client'
import type { AppRouter } from '@consulting-platform/api'

export const trpc = createTRPCReact<AppRouter>()

export const trpcClient = trpc.createClient({
  links: [
    httpBatchLink({
      url: '/api/trpc',
      headers() {
        return {
          'x-trpc-source': 'react',
        }
      },
    }),
  ],
})
```

### 9. Deployment Commands

#### Deploy All Services
```bash
# Deploy everything
railway up

# Deploy specific service
railway up --service web
railway up --service worker
```

#### Manual Deployment
```bash
# Build and deploy web service
pnpm build:web
railway up --service web

# Build and deploy worker service
pnpm build:worker
railway up --service worker
```

### 10. Health Checks and Monitoring

#### Health Check Endpoint
```typescript
// apps/web/app/api/health/route.ts
import { NextResponse } from 'next/server'
import { db } from '@consulting-platform/database'
import { redis } from '@consulting-platform/redis'

export async function GET() {
  try {
    // Check database connection
    await db.query('SELECT 1')
    
    // Check Redis connection
    await redis.ping()
    
    return NextResponse.json({
      status: 'healthy',
      timestamp: new Date().toISOString(),
      services: {
        database: 'connected',
        redis: 'connected',
        ai: 'operational'
      },
      version: process.env.npm_package_version || '1.0.0'
    })
  } catch (error) {
    return NextResponse.json(
      {
        status: 'unhealthy',
        timestamp: new Date().toISOString(),
        error: error instanceof Error ? error.message : 'Unknown error'
      },
      { status: 500 }
    )
  }
}
```

#### Monitor Deployments
```bash
# View deployment logs
railway logs --service web
railway logs --service worker

# View build logs
railway logs --build

# Check service status
railway status
```

### 11. Domain and SSL

#### Generate Domain
```bash
# Generate Railway domain
railway domain

# Set custom domain (if you have one)
railway domain add your-domain.com
```

#### SSL Configuration
Railway automatically provides SSL certificates for all domains. No additional configuration needed.

### 12. Performance Optimization

#### Next.js Optimizations
```javascript
// next.config.js optimizations
const nextConfig = {
  // Enable compression
  compress: true,
  
  // Optimize bundle
  swcMinify: true,
  
  // Enable experimental features
  experimental: {
    serverComponentsExternalPackages: ['@aws-sdk/client-bedrock-runtime'],
    optimizePackageImports: ['@trpc/react-query', 'drizzle-orm'],
  },
  
  // Image optimization
  images: {
    domains: ['images.unsplash.com'],
    formats: ['image/webp', 'image/avif'],
  },
}
```

#### Database Optimizations
```typescript
// Connection pooling
const db = drizzle(postgres(process.env.DATABASE_URL!, {
  max: 20, // Maximum connections
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
}))
```

#### Redis Optimizations
```typescript
// Redis connection with optimizations
const redis = new Redis(process.env.REDIS_URL!, {
  maxRetriesPerRequest: 3,
  retryDelayOnFailover: 100,
  enableReadyCheck: false,
  maxLoadingTimeout: 5000,
})
```

### 13. Troubleshooting

#### Common Issues

**Build Failures**
```bash
# Check build logs
railway logs --build

# Common fixes
pnpm install --frozen-lockfile
pnpm build:web
```

**Database Connection Issues**
```bash
# Check database variables
railway variables | grep DATABASE_URL

# Test connection
railway run pnpm db:push
```

**Worker Service Issues**
```bash
# Check worker logs
railway logs --service worker

# Verify Redis connection
railway variables | grep REDIS_URL
```

**Memory Issues**
```bash
# Check service resources
railway status

# Scale up if needed
railway scale --service web --memory 1GB
```

#### Debug Commands
```bash
# View all logs
railway logs

# View specific service logs
railway logs --service web --follow

# Check environment variables
railway variables

# Connect to database
railway connect postgresql

# Connect to Redis
railway connect redis
```

### 14. Security Configuration

#### Environment Security
```bash
# Set secure environment variables
railway variables set NODE_ENV=production
railway variables set NEXT_TELEMETRY_DISABLED=1

# Rotate secrets regularly
railway variables set CLERK_SECRET_KEY=new-secret
railway variables set AWS_SECRET_ACCESS_KEY=new-secret
```

#### Security Headers
```javascript
// next.config.js security headers
async headers() {
  return [
    {
      source: '/(.*)',
      headers: [
        {
          key: 'X-Frame-Options',
          value: 'DENY',
        },
        {
          key: 'X-Content-Type-Options',
          value: 'nosniff',
        },
        {
          key: 'Referrer-Policy',
          value: 'origin-when-cross-origin',
        },
        {
          key: 'Permissions-Policy',
          value: 'camera=(), microphone=(), geolocation=()',
        },
      ],
    },
  ]
}
```

### 15. Monitoring and Alerts

#### Railway Monitoring
```bash
# View metrics
railway metrics

# Set up alerts
railway alerts add --service web --condition cpu > 80
railway alerts add --service web --condition memory > 90
```

#### Custom Monitoring
```typescript
// Health check with detailed metrics
export async function GET() {
  const start = Date.now()
  
  try {
    // Database health
    const dbStart = Date.now()
    await db.query('SELECT 1')
    const dbTime = Date.now() - dbStart
    
    // Redis health
    const redisStart = Date.now()
    await redis.ping()
    const redisTime = Date.now() - redisStart
    
    return NextResponse.json({
      status: 'healthy',
      timestamp: new Date().toISOString(),
      responseTime: Date.now() - start,
      services: {
        database: { status: 'connected', responseTime: dbTime },
        redis: { status: 'connected', responseTime: redisTime },
      },
    })
  } catch (error) {
    return NextResponse.json(
      { status: 'unhealthy', error: error.message },
      { status: 500 }
    )
  }
}
```

## ✅ Deployment Checklist

- [ ] Railway project created and linked
- [ ] PostgreSQL database added and configured
- [ ] Redis database added and configured
- [ ] Web service created with correct build commands
- [ ] Worker service created with correct start command
- [ ] All environment variables set
- [ ] Next.js 15 configuration optimized
- [ ] Drizzle ORM migrations applied
- [ ] tRPC endpoints tested
- [ ] Health checks passing
- [ ] Domain generated and accessible
- [ ] SSL certificates active
- [ ] Monitoring configured
- [ ] Security headers applied

## 🎯 Post-Deployment

### Verify Deployment
```bash
# Check all services are running
railway status

# Test health endpoint
curl https://your-app.railway.app/api/health

# Check logs for any errors
railway logs --follow
```

### Performance Testing
```bash
# Load test the API
curl -w "@curl-format.txt" -o /dev/null -s https://your-app.railway.app/api/health

# Test database performance
railway run pnpm db:studio
```

### Backup Strategy
```bash
# Database backup
railway run pg_dump $DATABASE_URL > backup.sql

# Environment variables backup
railway variables > env-backup.txt
```

## 📞 Support

- **Railway Docs**: [docs.railway.app](https://docs.railway.app)
- **Next.js Docs**: [nextjs.org/docs](https://nextjs.org/docs)
- **tRPC Docs**: [trpc.io](https://trpc.io)
- **Drizzle Docs**: [orm.drizzle.team](https://orm.drizzle.team)

---

*Last Updated: January 2024*  
*Deployment Version: 1.0.0*
