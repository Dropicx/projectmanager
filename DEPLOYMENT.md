# ğŸš€ Railway Deployment Guide

## Overview

This project requires **4 services** in Railway:

1. **Web Service** - Next.js application (Port 3000)
2. **Worker Service** - Background job processing
3. **PostgreSQL Database** - Main database
4. **Redis Database** - Job queues and caching

## ğŸ—ï¸ Railway Services Setup

### Step 1: Create Railway Project

1. Go to [Railway Dashboard](https://railway.app/dashboard)
2. Click "New Project"
3. Choose "Deploy from GitHub repo"
4. Connect your GitHub repository

### Step 2: Add Required Services

#### 2.1 Web Service (Main App)
- **Type**: Web Service
- **Source**: Your GitHub repo
- **Build Command**: `pnpm install --frozen-lockfile && pnpm build`
- **Start Command**: `pnpm start`
- **Port**: 3000
- **Health Check**: `/api/health`

#### 2.2 Worker Service (Background Jobs)
- **Type**: Background Service
- **Source**: Your GitHub repo
- **Start Command**: `pnpm worker:start`
- **No port needed**

#### 2.3 PostgreSQL Database
- **Type**: Database â†’ PostgreSQL
- **Railway will auto-generate**: `DATABASE_URL`

#### 2.4 Redis Database
- **Type**: Database â†’ Redis
- **Railway will auto-generate**: `REDIS_URL`

## ğŸ”§ Environment Variables

Set these in your Railway project dashboard:

### Required Variables
```bash
# Database (auto-generated by Railway)
DATABASE_URL=postgresql://user:pass@host:5432/db

# Authentication (get from Clerk dashboard)
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_live_xxx
CLERK_SECRET_KEY=sk_live_xxx

# AWS Bedrock (for AI features)
AWS_REGION=eu-central-1
AWS_ACCESS_KEY_ID=xxx
AWS_SECRET_ACCESS_KEY=xxx

# Redis (auto-generated by Railway)
REDIS_URL=redis://default:xxx@host:6379
```

### Optional Variables
```bash
# File uploads
UPLOADTHING_SECRET=sk_xxx
UPLOADTHING_APP_ID=xxx

# Monitoring
SENTRY_DSN=https://xxx@sentry.io/xxx
LANGFUSE_PUBLIC_KEY=pk_xxx
LANGFUSE_SECRET_KEY=sk_xxx
```

## ğŸ“ Service Configuration

### Web Service (`railway.toml`)
```toml
[services.web]
port = 3000
healthcheckPath = "/api/health"
healthcheckTimeout = 30
```

### Worker Service (`railway.toml`)
```toml
[services.worker]
startCommand = "pnpm worker:start"
restartPolicyType = "on-failure"
restartPolicyMaxRetries = 3
```

## ğŸ”„ GitHub Integration

### 1. Railway Token Setup
1. Go to Railway Dashboard â†’ Account Settings
2. Generate a new token
3. Add to GitHub Secrets: `RAILWAY_TOKEN`

### 2. GitHub Actions
The `.github/workflows/deploy.yml` will automatically:
- Build the project on push to main
- Deploy to Railway
- Run health checks

## ğŸš€ Deployment Commands

### Manual Deployment
```bash
# Deploy web service
railway up --service web

# Deploy worker service
railway up --service worker

# Deploy all services
railway up
```

### GitHub Deployment
- Push to `main` branch
- GitHub Actions will automatically deploy
- Check Railway dashboard for deployment status

## ğŸ” Service References

### In Your Code
```typescript
// Database connection
const db = drizzle(postgres(process.env.DATABASE_URL!))

// Redis connection
const redis = new Redis(process.env.REDIS_URL!)

// Service URLs (Railway provides these)
const webUrl = process.env.RAILWAY_PUBLIC_DOMAIN
const workerUrl = process.env.RAILWAY_WORKER_URL
```

### Environment Variables by Service
- **Web Service**: All environment variables
- **Worker Service**: Database and Redis URLs only
- **Database Services**: Auto-generated connection strings

## ğŸ“Š Monitoring

### Health Checks
- **Web Service**: `https://your-app.railway.app/api/health`
- **Worker Service**: Check Railway logs

### Logs
```bash
# Web service logs
railway logs --service web

# Worker service logs
railway logs --service worker

# All logs
railway logs
```

## ğŸ› ï¸ Troubleshooting

### Common Issues
1. **Build fails**: Check Node.js version (22+ required)
2. **Database connection**: Verify `DATABASE_URL` is set
3. **Worker not starting**: Check `REDIS_URL` is set
4. **Health check fails**: Verify `/api/health` endpoint exists

### Debug Commands
```bash
# Check service status
railway status

# View environment variables
railway variables

# Check logs
railway logs --build
railway logs --deploy
```

## ğŸ¯ Final Architecture

```
Railway Project
â”œâ”€â”€ Web Service (Next.js App)
â”‚   â”œâ”€â”€ Port: 3000
â”‚   â”œâ”€â”€ Health: /api/health
â”‚   â””â”€â”€ Domain: https://your-app.railway.app
â”œâ”€â”€ Worker Service (Background Jobs)
â”‚   â”œâ”€â”€ No port
â”‚   â””â”€â”€ Processes: BullMQ jobs
â”œâ”€â”€ PostgreSQL Database
â”‚   â””â”€â”€ Connection: DATABASE_URL
â””â”€â”€ Redis Database
    â””â”€â”€ Connection: REDIS_URL
```

## âœ… Deployment Checklist

- [ ] GitHub repository connected
- [ ] Web service created and configured
- [ ] Worker service created and configured
- [ ] PostgreSQL database added
- [ ] Redis database added
- [ ] Environment variables set
- [ ] Railway token added to GitHub secrets
- [ ] Health checks passing
- [ ] Domain generated and accessible

## ğŸš€ Go Live!

Once all services are configured and environment variables are set:

1. Push to `main` branch
2. Railway will automatically deploy
3. Your app will be live at: `https://your-app.railway.app`
4. Monitor logs and health checks
5. Set up custom domain (optional)
